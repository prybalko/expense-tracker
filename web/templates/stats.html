{{define "content"}}
<div class="screen stats-screen">
    <section class="stats-content">
        <!-- Header with View Selector -->
        <div class="insights-header">
            <h1 class="insights-title">Insights</h1>
            <div class="view-selector">
                <select id="view-mode-select" onchange="this.blur(); changeViewMode(this.value, {{.Year}}, {{.Month}})">
                    <option value="month" {{if eq .ViewMode "month"}}selected{{end}}>month</option>
                    <option value="year" {{if eq .ViewMode "year"}}selected{{end}}>year</option>
                </select>
            </div>
        </div>

        <!-- Period Navigation -->
        <div class="period-selector">
            {{if eq .ViewMode "year"}}
            <button class="period-nav"
                    hx-get="/statistics?view=year&year={{.PrevYear}}"
                    hx-target="#content"
                    hx-push-url="true">‹</button>
            <h2 class="period-title">{{.Year}}</h2>
            <button class="period-nav"
                    {{if not .IsCurrentPeriod}}
                    hx-get="/statistics?view=year&year={{.NextYear}}"
                    hx-target="#content"
                    hx-push-url="true"
                    {{else}}
                    disabled style="opacity: 0.3; cursor: not-allowed;"
                    {{end}}>›</button>
            {{else}}
            <button class="period-nav"
                    hx-get="/statistics?view=month&year={{.PrevYear}}&month={{.PrevMonth}}"
                    hx-target="#content"
                    hx-push-url="true">‹</button>
            <h2 class="period-title">{{.MonthName}} {{.Year}}</h2>
            <button class="period-nav"
                    {{if not .IsCurrentPeriod}}
                    hx-get="/statistics?view=month&year={{.NextYear}}&month={{.NextMonth}}"
                    hx-target="#content"
                    hx-push-url="true"
                    {{else}}
                    disabled style="opacity: 0.3; cursor: not-allowed;"
                    {{end}}>›</button>
            {{end}}
        </div>

        <!-- Enhanced Stats Summary -->
        <section class="stats-summary-enhanced">
            <div class="stat-card">
                <small class="stat-label">{{.Year}}</small>
                <div class="stat-main">
                    <span class="stat-amount"><span class="currency">-€</span>{{printf "%.0f" .Total}}</span>
                    {{if .HasChange}}
                    <span class="percentage-badge {{if .IsIncrease}}increase{{else}}decrease{{end}}">
                        {{if .IsIncrease}}+{{else}}-{{end}}{{printf "%.0f" .PercentageChange}}%
                    </span>
                    {{end}}
                </div>
            </div>
            <div class="stat-card">
                <small class="stat-label">{{.AverageLabel}}</small>
                <div class="stat-value"><span class="currency">€</span>{{printf "%.0f" .AverageSpending}}</div>
            </div>
        </section>

        <!-- Bar Chart -->
        {{if .ChartData}}
        <section class="chart-section">
            <div class="chart-container" data-max-value="{{.MaxChartValue}}" data-average="{{.AverageSpending}}">
                <!-- Chart bars -->
                <div class="chart-bars">
                    {{range $index, $point := .ChartData}}
                    <div class="chart-bar-wrapper" title="{{if ne $point.Label ""}}{{$point.Label}}: {{end}}€{{printf "%.2f" $point.Value}}">
                        <div class="chart-bar" data-value="{{$point.Value}}"></div>
                    </div>
                    {{end}}

                    <!-- Average line -->
                    {{if and (gt .AverageSpending 0.0) (gt .MaxChartValue 0.0)}}
                    <div class="average-line">
                        <span class="average-label">{{printf "%.0f" .AverageSpending}}</span>
                    </div>
                    {{end}}
                </div>

                <!-- Chart Labels -->
                <div class="chart-labels">
                    {{range .ChartData}}
                    <span class="chart-label">{{.Label}}</span>
                    {{end}}
                </div>
            </div>
        </section>
        {{end}}

        <!-- Category Breakdown -->
        {{if .Categories}}
        <section class="category-breakdown">
            <h3>Spending by Category</h3>
            <div class="category-list">
                {{range .Categories}}
                <div class="category-group" data-category="{{.Category}}">
                    <div class="category-item" onclick="toggleCategoryTransactions(this)">
                        <div class="category-info">
                            <div class="cat-icon" style="background-color: {{.CategoryStyle.Color}}">{{.CategoryStyle.Icon}}</div>
                            <div class="category-details">
                                <strong>{{.Category}}</strong>
                                <small>{{.Count}} transaction{{if ne .Count 1}}s{{end}}</small>
                            </div>
                        </div>
                        <div class="category-amount">
                            <strong>
                                €{{printf "%.2f" .Total}}
                            </strong>
                            <small class="percentage">{{printf "%.1f" .Percentage}}%</small>
                        </div>
                    </div>
                    <div class="category-bar">
                        <div class="category-bar-fill" style="width: {{printf "%.1f" .Percentage}}%; background-color: {{.CategoryStyle.Color}}"></div>
                    </div>
                    <div class="category-transactions"></div>
                </div>
                {{end}}
            </div>
        </section>
        {{end}}

        {{if not .Expenses}}
        <section class="empty-state">
            <p>No expenses recorded for this period</p>
        </section>
        {{end}}
    </section>

    <nav class="fab-bar">
        <button hx-get="/expenses" hx-target="#content" hx-push-url="true"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-list-icon lucide-list"><path d="M3 5h.01"/><path d="M3 12h.01"/><path d="M3 19h.01"/><path d="M8 5h13"/><path d="M8 12h13"/><path d="M8 19h13"/></svg></button>
        <button class="fab-add" onclick="openCreateModal()"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-plus-icon lucide-plus"><path d="M5 12h14"/><path d="M12 5v14"/></svg></button>
        <button class="active"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-chart-no-axes-combined-icon lucide-chart-no-axes-combined"><path d="M12 16v5"/><path d="M16 14v7"/><path d="M20 10v11"/><path d="m22 3-8.646 8.646a.5.5 0 0 1-.708 0L9.354 8.354a.5.5 0 0 0-.707 0L2 15"/><path d="M4 18v3"/><path d="M8 14v7"/></svg></button>
    </nav>
</div>

<script>
// Transaction data stored as JSON (more efficient than hidden DOM)
// Using window. to allow re-declaration when HTMX swaps content
window.transactionData = [
{{- range .Expenses}}
    {id:"{{.ID}}",amount:{{.Amount}},description:{{js .Description}},category:{{js .Category}},datetime:"{{.DateTime}}",time:"{{.Time}}",isIncome:{{.IsIncome}}},
{{- end}}
];

function changeViewMode(view, year, month) {
    let url = '/statistics?view=' + view;
    if (view === 'year') {
        url += '&year=' + year;
    } else {
        url += '&year=' + year + '&month=' + month;
    }
    htmx.ajax('GET', url, {target: '#content', swap: 'innerHTML', push: true});
}

// Render a transaction item from data
function renderTransaction(t) {
    const amountClass = t.isIncome ? 'expense-amount income' : 'expense-amount';
    const sign = t.isIncome ? '+' : '-';
    // Escape HTML entities for safe rendering
    const escHtml = s => s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
    // Escape for use in HTML attributes
    const escAttr = s => s.replace(/&/g,'&amp;').replace(/"/g,'&quot;');
    return `<article class="expense-item" data-id="${t.id}" data-amount="${t.amount}" data-description="${escAttr(t.description)}" data-category="${escAttr(t.category)}" data-datetime="${t.datetime}" onclick="openEditModal(this.dataset.id, this.dataset.amount, this.dataset.description, this.dataset.category, this.dataset.datetime)">
        <div class="expense-info">
            <div class="expense-details">
                <strong>${escHtml(t.description)}</strong>
                <small>${t.time}</small>
            </div>
        </div>
        <span class="${amountClass}">${sign}€${t.amount.toFixed(2)}</span>
    </article>`;
}

// Toggle category transactions visibility
function toggleCategoryTransactions(categoryItem) {
    const group = categoryItem.closest('.category-group');
    const category = group.dataset.category;
    const container = group.querySelector('.category-transactions');
    const isExpanded = group.classList.contains('expanded');

    if (isExpanded) {
        // Collapse
        group.classList.remove('expanded');
        container.style.maxHeight = '0';
        setTimeout(() => { container.innerHTML = ''; }, 300);
    } else {
        // Collapse any other expanded categories first
        document.querySelectorAll('.category-group.expanded').forEach(g => {
            g.classList.remove('expanded');
            const c = g.querySelector('.category-transactions');
            c.style.maxHeight = '0';
            setTimeout(() => { c.innerHTML = ''; }, 300);
        });

        // Filter transactions by category from JSON data
        const matching = window.transactionData.filter(t => t.category === category);

        if (matching.length === 0) {
            container.innerHTML = '<div class="no-transactions">No transactions</div>';
        } else {
            // Render transactions from data
            container.innerHTML = '<div class="expense-list">' + matching.map(renderTransaction).join('') + '</div>';
        }

        // Expand with animation
        group.classList.add('expanded');
        container.style.maxHeight = container.scrollHeight + 'px';
    }
}

// Initialize chart bar heights
(function() {
    const container = document.querySelector('.chart-container');
    if (!container) return;

    const maxValue = parseFloat(container.dataset.maxValue) || 0;
    const average = parseFloat(container.dataset.average) || 0;

    if (maxValue <= 0) return;

    // Set bar heights
    document.querySelectorAll('.chart-bar').forEach(bar => {
        const value = parseFloat(bar.dataset.value) || 0;
        const heightPercent = (value / maxValue) * 100;
        bar.style.height = heightPercent + '%';
    });

    // Set average line position
    if (average > 0) {
        const avgLine = document.querySelector('.average-line');
        if (avgLine) {
            const avgPercent = (average / maxValue) * 100;
            avgLine.style.bottom = avgPercent + '%';
        }
    }
})();
</script>
{{end}}
