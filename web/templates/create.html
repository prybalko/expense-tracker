{{define "content"}}
<div class="screen create-screen">
    <header class="header">
        <button class="close-btn" hx-get="/expenses" hx-target="#content" hx-push-url="true">Ã—</button>
    </header>

    <form class="create-form" 
          method="POST"
          {{if .IsEdit}}action="/expenses/{{.Expense.ID}}" hx-post="/expenses/{{.Expense.ID}}"{{else}}action="/expenses" hx-post="/expenses"{{end}} 
          hx-target="#content" 
          id="expense-form">
        <section class="amount-display">
            <div class="amount-row">
                <div class="amount-hero">
                    <span class="currency">â‚¬</span><span id="display-amount">{{if .IsEdit}}{{printf "%.2f" .Expense.Amount}}{{else}}0{{end}}</span>
                </div>
                <button type="button" class="delete-btn" onclick="backspace()">âŒ«</button>
            </div>
            <input type="hidden" name="amount" id="amount-input" value="{{if .IsEdit}}{{printf "%.2f" .Expense.Amount}}{{else}}0{{end}}">
            <input type="text" name="description" placeholder="Add Note" class="note-input" autocomplete="off" value="{{if .IsEdit}}{{.Expense.Description}}{{end}}">
        </section>

        <section class="selectors">
            <div class="selector" onclick="openDatePicker()">
                <input type="hidden" name="date" id="date-input" value="{{if .IsEdit}}{{.FormattedDate}}{{end}}">
                <div class="selector-btn">
                    <span>ðŸ“…</span><span id="date-display">Today</span>
                </div>
            </div>
            <label class="selector">
                <select name="category" id="category-select" onchange="updateCategoryDisplay(this)">
                    {{range .Categories}}
                    <option value="{{.Name}}"{{if and $.IsEdit (eq $.Expense.Category .Name)}} selected{{end}}>{{.Icon}} {{.Name}}</option>
                    {{end}}
                </select>
                <div class="selector-btn">
                    <span id="cat-icon"></span><span id="category-display">Category</span>
                </div>
            </label>
        </section>

        <section class="keypad">
            <button type="button" onclick="appendNum('1')">1</button>
            <button type="button" onclick="appendNum('2')">2</button>
            <button type="button" onclick="appendNum('3')">3</button>
            <button type="button" onclick="appendNum('4')">4</button>
            <button type="button" onclick="appendNum('5')">5</button>
            <button type="button" onclick="appendNum('6')">6</button>
            <button type="button" onclick="appendNum('7')">7</button>
            <button type="button" onclick="appendNum('8')">8</button>
            <button type="button" onclick="appendNum('9')">9</button>
            <button type="button" onclick="appendNum('.')">.</button>
            <button type="button" onclick="appendNum('0')">0</button>
            <button type="submit" class="submit">âœ“</button>
        </section>
    </form>

    <!-- Date Picker Modal -->
    <div class="date-modal-overlay" onclick="if(event.target === this) closeDatePicker()">
        <div class="date-modal">
            <div class="calendar-header">
                <button type="button" onclick="changeMonth(-1)">â€¹</button>
                <h3 id="calendar-month-year">Month Year</h3>
                <button type="button" onclick="changeMonth(1)">â€º</button>
            </div>
            <div class="calendar-grid" id="calendar-grid">
                <!-- Headers -->
                <div class="calendar-day-header">Mo</div>
                <div class="calendar-day-header">Tu</div>
                <div class="calendar-day-header">We</div>
                <div class="calendar-day-header">Th</div>
                <div class="calendar-day-header">Fr</div>
                <div class="calendar-day-header">Sa</div>
                <div class="calendar-day-header">Su</div>
                <!-- Days will be injected here -->
            </div>
        </div>
    </div>

    <script>
    (function() {
        const icons = {
            {{range .Categories}}"{{.Name}}":"{{.Icon}}",{{end}}
        };
        let amt = document.getElementById('amount-input').value || '0';
        if (amt.includes('.')) amt = parseFloat(amt).toString();

        function updateCategory(sel) {
            document.getElementById('category-display').textContent = sel.value.charAt(0).toUpperCase() + sel.value.slice(1);
            document.getElementById('cat-icon').textContent = icons[sel.value] || 'ðŸ“¦';
        }

        function update() {
            document.getElementById('display-amount').textContent = amt;
            document.getElementById('amount-input').value = amt;
        }

        window.updateCategoryDisplay = updateCategory;
        
        window.appendNum = function(n) {
            if (amt === '0' && n !== '.') amt = n;
            else if (n === '.' && amt.includes('.')) return;
            else if (amt.replace('.','').length >= 9) return;
            else amt += n;
            update();
        };

        window.backspace = function() {
            amt = amt.length === 1 ? '0' : amt.slice(0, -1);
            update();
        };

        // Init
        const dateInput = document.getElementById('date-input');
        if (!dateInput.value) {
            const now = new Date();
            now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
            dateInput.value = now.toISOString().slice(0, 19);
        }
        if (window.updateDateDisplay) {
            updateDateDisplay(dateInput);
        }
        updateCategory(document.getElementById('category-select'));
        document.getElementById('display-amount').textContent = amt;
    })();
    </script>
</div>
{{end}}
