{{define "content"}}
<div class="screen create-screen">
    <header class="header">
        <button class="close-btn" hx-get="/expenses" hx-target="#content" hx-push-url="true">√ó</button>
    </header>

    <form class="create-form" 
          {{if .IsEdit}}hx-post="/expenses/{{.Expense.ID}}"{{else}}hx-post="/expenses"{{end}} 
          hx-target="#content" 
          id="expense-form">
        <section class="amount-display">
            <div class="amount-hero">
                <span class="currency">‚Ç¨</span><span id="display-amount">{{if .IsEdit}}{{printf "%.2f" .Expense.Amount}}{{else}}0{{end}}</span>
            </div>
            <input type="hidden" name="amount" id="amount-input" value="{{if .IsEdit}}{{printf "%.2f" .Expense.Amount}}{{else}}0{{end}}">
            <input type="text" name="description" placeholder="Add Note" class="note-input" autocomplete="off" value="{{if .IsEdit}}{{.Expense.Description}}{{end}}">
        </section>

        <section class="selectors">
            <label class="selector">
                <input type="datetime-local" name="date" id="date-input" value="{{if .IsEdit}}{{.FormattedDate}}{{end}}" onchange="updateDateDisplay(this)">
                <div class="selector-btn">
                    <span>üìÖ</span><span id="date-display">Today</span>
                </div>
            </label>
            <label class="selector">
                <select name="category" id="category-select" onchange="updateCategoryDisplay(this)">
                    <option value="food"{{if and .IsEdit (eq .Expense.Category "food")}} selected{{end}}>Food</option>
                    <option value="transport"{{if and .IsEdit (eq .Expense.Category "transport")}} selected{{end}}>Transport</option>
                    <option value="entertainment"{{if and .IsEdit (eq .Expense.Category "entertainment")}} selected{{end}}>Entertainment</option>
                    <option value="utilities"{{if and .IsEdit (eq .Expense.Category "utilities")}} selected{{end}}>Utilities</option>
                    <option value="housing"{{if and .IsEdit (eq .Expense.Category "housing")}} selected{{end}}>Housing</option>
                    <option value="gifts"{{if and .IsEdit (eq .Expense.Category "gifts")}} selected{{end}}>Gifts</option>
                    <option value="other"{{if and .IsEdit (eq .Expense.Category "other")}} selected{{end}}>Other</option>
                </select>
                <div class="selector-btn">
                    <span id="cat-icon">üçΩÔ∏è</span><span id="category-display">Food</span>
                </div>
            </label>
        </section>

        <section class="keypad">
            <button type="button" onclick="appendNum('1')">1</button>
            <button type="button" onclick="appendNum('2')">2</button>
            <button type="button" onclick="appendNum('3')">3</button>
            <button type="button" onclick="appendNum('4')">4</button>
            <button type="button" onclick="appendNum('5')">5</button>
            <button type="button" onclick="appendNum('6')">6</button>
            <button type="button" onclick="appendNum('7')">7</button>
            <button type="button" onclick="appendNum('8')">8</button>
            <button type="button" onclick="appendNum('9')">9</button>
            <button type="button" onclick="appendNum('.')">.</button>
            <button type="button" onclick="appendNum('0')">0</button>
            <button type="button" class="backspace" onclick="backspace()">‚å´</button>
            <button type="submit" class="submit">‚úì</button>
        </section>
    </form>

    <script>
    (function() {
        const icons = {food:'üçΩÔ∏è',transport:'üöå',entertainment:'üéÆ',utilities:'üí°',housing:'üè†',gifts:'üéÅ',other:'üì¶'};
        let amt = document.getElementById('amount-input').value || '0';
        if (amt.includes('.')) amt = parseFloat(amt).toString();

        function updateDate(input) {
            const d = new Date(input.value || new Date());
            const isToday = d.toDateString() === new Date().toDateString();
            document.getElementById('date-display').textContent = isToday ? 'Today' : d.toLocaleDateString(undefined, {day:'numeric',month:'short'});
        }

        function updateCategory(sel) {
            document.getElementById('category-display').textContent = sel.value.charAt(0).toUpperCase() + sel.value.slice(1);
            document.getElementById('cat-icon').textContent = icons[sel.value] || 'üì¶';
        }

        function update() {
            document.getElementById('display-amount').textContent = amt;
            document.getElementById('amount-input').value = amt;
        }

        window.updateDateDisplay = updateDate;
        window.updateCategoryDisplay = updateCategory;

        window.appendNum = function(n) {
            if (amt === '0' && n !== '.') amt = n;
            else if (n === '.' && amt.includes('.')) return;
            else if (amt.replace('.','').length >= 9) return;
            else amt += n;
            update();
        };

        window.backspace = function() {
            amt = amt.length === 1 ? '0' : amt.slice(0, -1);
            update();
        };

        // Init
        const dateInput = document.getElementById('date-input');
        if (!dateInput.value) {
            const now = new Date();
            now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
            dateInput.value = now.toISOString().slice(0, 16);
        }
        updateDate(dateInput);
        updateCategory(document.getElementById('category-select'));
        document.getElementById('display-amount').textContent = amt;
    })();
    </script>
</div>
{{end}}
