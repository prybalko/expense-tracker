{{define "content"}}
<div class="screen create-screen">
    <header class="header">
        <button class="close-btn" hx-get="/expenses" hx-target="#content" hx-push-url="true">Ã—</button>
    </header>

    <form class="create-form" 
          {{if .IsEdit}}hx-post="/expenses/{{.Expense.ID}}"{{else}}hx-post="/expenses"{{end}} 
          hx-target="#content" 
          id="expense-form">
        <section class="amount-display">
            <div class="amount-row">
                <div class="amount-hero">
                    <span class="currency">â‚¬</span><span id="display-amount">{{if .IsEdit}}{{printf "%.2f" .Expense.Amount}}{{else}}0{{end}}</span>
                </div>
                <button type="button" class="delete-btn" onclick="backspace()">âŒ«</button>
            </div>
            <input type="hidden" name="amount" id="amount-input" value="{{if .IsEdit}}{{printf "%.2f" .Expense.Amount}}{{else}}0{{end}}">
            <input type="text" name="description" placeholder="Add Note" class="note-input" autocomplete="off" value="{{if .IsEdit}}{{.Expense.Description}}{{end}}">
        </section>

        <section class="selectors">
            <div class="selector" onclick="openDatePicker()">
                <input type="hidden" name="date" id="date-input" value="{{if .IsEdit}}{{.FormattedDate}}{{end}}">
                <div class="selector-btn">
                    <span>ðŸ“…</span><span id="date-display">Today</span>
                </div>
            </div>
            <label class="selector">
                <select name="category" id="category-select" onchange="updateCategoryDisplay(this)">
                    {{range .Categories}}
                    <option value="{{.ID}}"{{if and $.IsEdit (eq $.Expense.Category .ID)}} selected{{end}}>{{.Icon}} {{.Name}}</option>
                    {{end}}
                </select>
                <div class="selector-btn">
                    <span id="cat-icon"></span><span id="category-display">Category</span>
                </div>
            </label>
        </section>

        <section class="keypad">
            <button type="button" onclick="appendNum('1')">1</button>
            <button type="button" onclick="appendNum('2')">2</button>
            <button type="button" onclick="appendNum('3')">3</button>
            <button type="button" onclick="appendNum('4')">4</button>
            <button type="button" onclick="appendNum('5')">5</button>
            <button type="button" onclick="appendNum('6')">6</button>
            <button type="button" onclick="appendNum('7')">7</button>
            <button type="button" onclick="appendNum('8')">8</button>
            <button type="button" onclick="appendNum('9')">9</button>
            <button type="button" onclick="appendNum('.')">.</button>
            <button type="button" onclick="appendNum('0')">0</button>
            <button type="submit" class="submit">âœ“</button>
        </section>
    </form>

    <!-- Date Picker Modal -->
    <div class="date-modal-overlay" onclick="if(event.target === this) closeDatePicker()">
        <div class="date-modal">
            <div class="calendar-header">
                <button type="button" onclick="changeMonth(-1)">â€¹</button>
                <h3 id="calendar-month-year">Month Year</h3>
                <button type="button" onclick="changeMonth(1)">â€º</button>
            </div>
            <div class="calendar-grid" id="calendar-grid">
                <!-- Headers -->
                <div class="calendar-day-header">Su</div>
                <div class="calendar-day-header">Mo</div>
                <div class="calendar-day-header">Tu</div>
                <div class="calendar-day-header">We</div>
                <div class="calendar-day-header">Th</div>
                <div class="calendar-day-header">Fr</div>
                <div class="calendar-day-header">Sa</div>
                <!-- Days will be injected here -->
            </div>
        </div>
    </div>

    <script>
    (function() {
        const icons = {
            {{range .Categories}}"{{.ID}}":"{{.Icon}}",{{end}}
        };
        let amt = document.getElementById('amount-input').value || '0';
        if (amt.includes('.')) amt = parseFloat(amt).toString();

        // Date Picker Logic
        let viewDate = new Date();
        
        window.openDatePicker = function() {
            const input = document.getElementById('date-input');
            const val = input.value;
            if (val) viewDate = new Date(val);
            else viewDate = new Date();
            
            renderCalendar();
            document.querySelector('.date-modal-overlay').classList.add('open');
        };

        window.closeDatePicker = function() {
            document.querySelector('.date-modal-overlay').classList.remove('open');
        };

        window.changeMonth = function(delta) {
            viewDate.setMonth(viewDate.getMonth() + delta);
            renderCalendar();
        };

        window.selectDate = function(year, month, day) {
            const input = document.getElementById('date-input');
            // Preserve time if editing, else default to current time or 12:00
            let timePart = '12:00';
            if (input.value && input.value.includes('T')) {
                timePart = input.value.split('T')[1];
            } else {
                const now = new Date();
                timePart = now.toTimeString().slice(0, 5);
            }

            const d = new Date(year, month, day);
            const dateStr = d.getFullYear() + '-' + 
                           String(d.getMonth() + 1).padStart(2, '0') + '-' + 
                           String(d.getDate()).padStart(2, '0');
            
            input.value = dateStr + 'T' + timePart;
            updateDateDisplay(input);
            closeDatePicker();
        };

        window.renderCalendar = function() {
            const year = viewDate.getFullYear();
            const month = viewDate.getMonth();
            
            const monthNames = ["January", "February", "March", "April", "May", "June",
                "July", "August", "September", "October", "November", "December"
            ];
            document.getElementById('calendar-month-year').textContent = monthNames[month] + ' ' + year;

            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const daysInMonth = lastDay.getDate();
            const startDay = firstDay.getDay(); // 0 = Sunday

            const grid = document.getElementById('calendar-grid');
            // Clear existing days (keep headers)
            const headers = grid.querySelectorAll('.calendar-day-header');
            grid.innerHTML = '';
            headers.forEach(h => grid.appendChild(h));

            // Empty slots
            for (let i = 0; i < startDay; i++) {
                const div = document.createElement('div');
                div.className = 'calendar-day empty';
                grid.appendChild(div);
            }

            // Days
            const today = new Date();
            const inputDate = new Date(document.getElementById('date-input').value || new Date());

            for (let d = 1; d <= daysInMonth; d++) {
                const div = document.createElement('div');
                div.className = 'calendar-day';
                div.textContent = d;
                
                // Check if today
                if (year === today.getFullYear() && month === today.getMonth() && d === today.getDate()) {
                    div.classList.add('today');
                }
                
                // Check if selected
                if (year === inputDate.getFullYear() && month === inputDate.getMonth() && d === inputDate.getDate()) {
                    div.classList.add('selected');
                }

                div.onclick = () => selectDate(year, month, d);
                grid.appendChild(div);
            }
        };

        function updateDateDisplay(input) {
            const d = new Date(input.value || new Date());
            const isToday = d.toDateString() === new Date().toDateString();
            document.getElementById('date-display').textContent = isToday ? 'Today' : d.toLocaleDateString(undefined, {day:'numeric',month:'short'});
        }

        function updateCategory(sel) {
            document.getElementById('category-display').textContent = sel.value.charAt(0).toUpperCase() + sel.value.slice(1);
            document.getElementById('cat-icon').textContent = icons[sel.value] || 'ðŸ“¦';
        }

        function update() {
            document.getElementById('display-amount').textContent = amt;
            document.getElementById('amount-input').value = amt;
        }

        window.updateCategoryDisplay = updateCategory;
        
        window.appendNum = function(n) {
            if (amt === '0' && n !== '.') amt = n;
            else if (n === '.' && amt.includes('.')) return;
            else if (amt.replace('.','').length >= 9) return;
            else amt += n;
            update();
        };

        window.backspace = function() {
            amt = amt.length === 1 ? '0' : amt.slice(0, -1);
            update();
        };

        // Init
        const dateInput = document.getElementById('date-input');
        if (!dateInput.value) {
            const now = new Date();
            now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
            dateInput.value = now.toISOString().slice(0, 16);
        }
        updateDateDisplay(dateInput);
        updateCategory(document.getElementById('category-select'));
        document.getElementById('display-amount').textContent = amt;
    })();
    </script>
</div>
{{end}}
